<!DOCTYPE html>
<html dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>لوحة تحكم أشير</title>
<style>
  body{font-family:Arial;background:#f5f7fa;padding:20px}
  .box{background:#fff;padding:16px;border-radius:12px;max-width:980px;margin:auto;box-shadow:0 10px 30px rgba(0,0,0,.06)}
  .top{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .badge{padding:8px 10px;border-radius:10px;background:#eef2ff;color:#1e2a78;font-size:13px}
  .btn{background:#ff6b00;color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn:active{transform:scale(.98)}
  .danger{background:#e11d48}
  table{width:100%;border-collapse:collapse;margin-top:14px}
  th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px}
  th{background:#0b1a2e;color:#fff}
  .muted{color:#6b7280;font-size:13px;margin-top:10px}
  .err{background:#fff1f2;color:#9f1239;border:1px solid #fecdd3;padding:10px;border-radius:10px;margin-top:10px;display:none;white-space:pre-wrap}
</style>
</head>
<body>

<div class="box">
  <div class="top">
    <h3 style="margin:0">لوحة التحكم</h3>
    <div class="badge" id="backendText"></div>
    <button class="btn" onclick="loadOrders()">تحديث</button>
  </div>

  <div class="muted">إذا كانت القائمة فارغة: إمّا لا توجد طلبات، أو رابط الـ Backend غير صحيح.</div>
  <div class="err" id="errBox"></div>

  <table>
    <thead>
      <tr>
        <th>الاسم</th>
        <th>الهاتف</th>
        <th>المدينة</th>
        <th>ملاحظة</th>
        <th>حذف</th>
      </tr>
    </thead>
    <tbody id="orders"></tbody>
  </table>
</div>

<script>
  // ✅ هذا هو الـ Backend الذي ظهر فيه الطلب عندك
  const BACKEND = "https://achir-backend.onrender.com";
  const API = BACKEND + "/api/orders";

  document.getElementById("backendText").textContent = "Backend: " + BACKEND;

  function showError(msg){
    const box = document.getElementById("errBox");
    box.style.display = "block";
    box.textContent = msg;
  }
  function hideError(){
    const box = document.getElementById("errBox");
    box.style.display = "none";
    box.textContent = "";
  }

  async function loadOrders(){
    hideError();
    document.getElementById("orders").innerHTML = "";
    try{
      const res = await fetch(API, { method:"GET" });
      const txt = await res.text();

      // إذا رجع HTML أو خطأ، نعرضه
      let data;
      try { data = JSON.parse(txt); } catch(e) {
        showError("الرد ليس JSON. ربما رابط API خطأ.\n\nResponse:\n" + txt.slice(0,500));
        return;
      }

      if(!Array.isArray(data)){
        showError("الـ Backend رجّع JSON لكن ليس Array.\n\nJSON:\n" + JSON.stringify(data, null, 2));
        return;
      }

      if(data.length === 0){
        document.getElementById("orders").innerHTML =
          `<tr><td colspan="5" style="text-align:center;color:#6b7280;padding:20px">لا توجد طلبات حالياً</td></tr>`;
        return;
      }

      data.slice().reverse().forEach(o=>{
        const id = o.id ?? o._id ?? "";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(o.name ?? "")}</td>
          <td>${escapeHtml(o.phone ?? "")}</td>
          <td>${escapeHtml(o.city ?? "")}</td>
          <td>${escapeHtml(o.note ?? "")}</td>
          <td><button class="btn danger" onclick="deleteOrder('${id}')">حذف</button></td>
        `;
        document.getElementById("orders").appendChild(tr);
      });

    }catch(err){
      showError("فشل الاتصال بالـ Backend.\n\n" + err);
    }
  }

  async function deleteOrder(id){
    if(!id){ showError("لا يوجد id للحذف (Backend لا يرسل id)."); return; }
    hideError();
    try{
      const res = await fetch(API + "/" + id, { method:"DELETE" });
      if(!res.ok){
        const t = await res.text();
        showError("فشل الحذف.\n\n" + t);
        return;
      }
      loadOrders();
    }catch(err){
      showError("خطأ أثناء الحذف.\n\n" + err);
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  loadOrders();
</script>

</body>
</html>
