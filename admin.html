<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة تحكم منصة أشير</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --brand:#ff7a00; --good:#16a34a; --bad:#dc2626;
      --line:#e5e7eb; --shadow:0 12px 30px rgba(2,6,23,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Tahoma,Arial;background:linear-gradient(180deg,#0b1220 0,#0b1220 160px,var(--bg) 160px);color:var(--text)}
    a{color:inherit;text-decoration:none}
    .topbar{padding:16px 14px;color:#fff;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44px;border-radius:14px;background:var(--brand);display:grid;place-items:center;font-weight:800;box-shadow:0 10px 25px rgba(255,122,0,.35)}
    .brand h1{margin:0;font-size:18px}
    .brand p{margin:0;color:rgba(255,255,255,.75);font-size:12px}
    .btn{border:0;border-radius:14px;padding:10px 14px;cursor:pointer;font-weight:700}
    .btn.brand{background:var(--brand);color:#fff}
    .btn.good{background:var(--good);color:#fff}
    .btn.dark{background:#111827;color:#fff;border:1px solid rgba(255,255,255,.15)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card-h{padding:18px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#fff,#fafafa)}
    .card-h h2{margin:0;font-size:18px}
    .card-h p{margin:8px 0 0;color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;padding:14px}
    input,textarea{
      padding:12px 12px;border-radius:14px;border:1px solid var(--line);
      outline:none;background:#fff;font-size:15px
    }
    .search{flex:1;min-width:220px}
    .stats{display:flex;gap:10px;flex-wrap:wrap}
    .pill{background:#fff;border:1px dashed var(--line);border-radius:999px;padding:8px 12px;color:var(--muted);font-size:13px}
    .pill b{color:var(--text)}
    .status{margin:0 14px 14px;padding:12px 14px;border-radius:14px;border:1px dashed var(--line);background:#fbfbfb;color:var(--muted);font-size:13px}
    .ok{border-color:#86efac;background:#f0fdf4;color:#166534}
    .bad{border-color:#fecaca;background:#fef2f2;color:#991b1b}

    table{width:100%;border-collapse:collapse}
    thead th{
      text-align:right;background:#0b1220;color:#fff;padding:12px;font-size:14px
    }
    tbody td{padding:12px;border-bottom:1px solid var(--line);vertical-align:top;font-size:14px}
    tbody tr:hover{background:#fafafa}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .mini{padding:8px 10px;border-radius:12px;font-weight:800;font-size:12px}
    .mini.del{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
    .mini.edit{background:#e0f2fe;color:#075985;border:1px solid #bae6fd}
    .mini.save{background:#dcfce7;color:#166534;border:1px solid #86efac}
    .mini.cancel{background:#f3f4f6;color:#111827;border:1px solid #e5e7eb}

    .login{display:grid;place-items:center;padding:24px}
    .login-box{max-width:520px;width:100%;padding:18px}
    .login-inner{padding:18px;display:grid;gap:12px}
    .warn{color:var(--muted);font-size:12px;line-height:1.8}
    .footer{padding:14px;text-align:center;color:var(--muted);font-size:12px;border-top:1px solid var(--line)}
    code{background:#f3f4f6;padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>

  <div class="topbar">
    <div class="brand">
      <div class="logo">A</div>
      <div>
        <h1>لوحة تحكم منصة أشير</h1>
        <p id="apiLine">Backend: ...</p>
      </div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn dark" onclick="location.href='index.html'">صفحة الطلب</button>
      <button class="btn brand" id="btnReload" style="display:none" onclick="loadOrders()">تحديث</button>
      <button class="btn good" id="btnExport" style="display:none" onclick="exportCSV()">تصدير Excel</button>
      <button class="btn dark" id="btnLogout" style="display:none" onclick="logout()">خروج</button>
    </div>
  </div>

  <div class="wrap">
    <div class="card" id="loginCard">
      <div class="card-h">
        <h2>تسجيل دخول لوحة التحكم</h2>
        <p>أدخل كلمة السر لعرض الطلبات وإدارتها.</p>
      </div>
      <div class="login">
        <div class="login-box">
          <div class="login-inner">
            <input id="pass" type="password" placeholder="كلمة السر" />
            <button class="btn brand" onclick="login()">دخول</button>
            <div class="warn">⚠️ ملاحظة: هذه حماية واجهة فقط. للحماية الحقيقية يجب حماية الحذف/التعديل داخل الـ Backend.</div>
            <div id="loginMsg" class="status">كلمة السر الحالية: <code>admin47</code></div>
          </div>
        </div>
      </div>
      <div class="footer">admin.html</div>
    </div>

    <div class="card" id="panelCard" style="display:none">
      <div class="card-h">
        <h2>الطلبات</h2>
        <p>بحث بالاسم/الهاتف/المدينة — والحذف/التعديل يتم مباشرة على الـ Backend.</p>
      </div>

      <div class="row">
        <input class="search" id="q" placeholder="بحث..." oninput="render()" />
        <div class="stats">
          <div class="pill">عدد الطلبات: <b id="count">0</b></div>
          <div class="pill">آخر تحميل: <b id="last">—</b></div>
        </div>
      </div>

      <div id="msg" class="status">جاهز…</div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="min-width:160px">الاسم</th>
              <th style="min-width:140px">الهاتف</th>
              <th style="min-width:120px">المدينة</th>
              <th>ملاحظة</th>
              <th style="min-width:160px">التاريخ</th>
              <th style="min-width:220px">إجراءات</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="6" style="text-align:center;color:#64748b;padding:24px">لا توجد طلبات حالياً</td></tr>
          </tbody>
        </table>
      </div>

      <div class="footer">Backend: <code id="apiText"></code></div>
    </div>
  </div>

<script>
  // ✅ عدّل هذا فقط إذا تغيّر رابط الـ Backend
  const API_BASE = "https://achir-backend.onrender.com";
  document.getElementById("apiLine").textContent = "Backend: " + API_BASE;
  document.getElementById("apiText").textContent = API_BASE;

  // ✅ كلمة السر (Front-End فقط)
  const ADMIN_PASSWORD = "admin47";

  let orders = [];
  let filtered = [];

  function setMsg(text, type){
    const el = document.getElementById("msg");
    el.className = "status " + (type || "");
    el.textContent = text;
  }
  function setLoginMsg(text, type){
    const el = document.getElementById("loginMsg");
    el.className = "status " + (type || "");
    el.textContent = text;
  }

  function login(){
    const v = document.getElementById("pass").value;
    if(v !== ADMIN_PASSWORD){
      setLoginMsg("❌ كلمة سر خاطئة", "bad");
      return;
    }
    localStorage.setItem("achir_admin_ok","1");
    showPanel();
  }
  function logout(){
    localStorage.removeItem("achir_admin_ok");
    location.reload();
  }
  function showPanel(){
    document.getElementById("loginCard").style.display="none";
    document.getElementById("panelCard").style.display="block";
    document.getElementById("btnReload").style.display="inline-block";
    document.getElementById("btnExport").style.display="inline-block";
    document.getElementById("btnLogout").style.display="inline-block";
    loadOrders();
  }

  async function apiGet(){
    const res = await fetch(`${API_BASE}/`);
    const text = await res.text();
    let data;
    try{ data = JSON.parse(text); } catch { data = text; }
    if(!res.ok) throw new Error(typeof data==="string" ? data : (data.message || "فشل التحميل"));
    if(!Array.isArray(data)) throw new Error("الـ Backend لم يرجع قائمة (Array).");
    return data;
  }

  async function apiDelete(id){
    const res = await fetch(`${API_BASE}/${id}`, { method:"DELETE" });
    if(!res.ok){
      const t = await res.text();
      throw new Error(t || "فشل الحذف");
    }
  }

  async function apiUpdate(id, payload){
    // نجرب PUT ثم PATCH كخطة بديلة
    let res = await fetch(`${API_BASE}/${id}`, {
      method:"PUT",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if(!res.ok){
      res = await fetch(`${API_BASE}/${id}`, {
        method:"PATCH",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
    }
    if(!res.ok){
      const t = await res.text();
      throw new Error(t || "فشل التحديث");
    }
  }

  async function loadOrders(){
    setMsg("⏳ جاري التحميل...", "");
    try{
      orders = await apiGet();
      // ترتيب تنازلي حسب id أو created_at
      orders.sort((a,b)=>{
        const ai = Number(a.id||0), bi = Number(b.id||0);
        if(bi!==ai) return bi-ai;
        return String(b.created_at||"").localeCompare(String(a.created_at||""));
      });
      document.getElementById("last").textContent = new Date().toLocaleString("ar-DZ");
      setMsg("✅ تم التحميل بنجاح.", "ok");
      render();
    }catch(err){
      setMsg("❌ فشل التحميل: " + err.message + " (تأكد من المسارات في Backend)", "bad");
      orders = [];
      render();
    }
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function render(){
    const q = document.getElementById("q").value.trim().toLowerCase();
    filtered = orders.filter(o=>{
      const all = `${o.name||""} ${o.phone||""} ${o.city||""} ${o.note||""}`.toLowerCase();
      return !q || all.includes(q);
    });

    document.getElementById("count").textContent = filtered.length;

    const tbody = document.getElementById("tbody");
    if(filtered.length === 0){
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#64748b;padding:24px">لا توجد طلبات حالياً</td></tr>`;
      return;
    }

    tbody.innerHTML = filtered.map(o=>{
      const id = o.id;
      const created = o.created_at || "—";
      return `
        <tr data-id="${escapeHtml(id)}">
          <td>
            <div class="view">${escapeHtml(o.name)}</div>
            <input class="editf" style="display:none;width:100%" value="${escapeHtml(o.name)}" data-k="name">
          </td>
          <td>
            <div class="view">${escapeHtml(o.phone)}</div>
            <input class="editf" style="display:none;width:100%" value="${escapeHtml(o.phone)}" data-k="phone">
          </td>
          <td>
            <div class="view">${escapeHtml(o.city)}</div>
            <input class="editf" style="display:none;width:100%" value="${escapeHtml(o.city)}" data-k="city">
          </td>
          <td>
            <div class="view">${escapeHtml(o.note)}</div>
            <textarea class="editf" style="display:none;width:100%;min-height:70px" data-k="note">${escapeHtml(o.note)}</textarea>
          </td>
          <td>${escapeHtml(created)}</td>
          <td>
            <div class="actions">
              <button class="mini edit" onclick="startEdit(${id})">تعديل</button>
              <button class="mini save" style="display:none" onclick="saveEdit(${id})">حفظ</button>
              <button class="mini cancel" style="display:none" onclick="cancelEdit(${id})">إلغاء</button>
              <button class="mini del" onclick="del(${id})">حذف</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");
  }

  function startEdit(id){
    const tr = document.querySelector(`tr[data-id="${id}"]`);
    tr.querySelectorAll(".view").forEach(x=>x.style.display="none");
    tr.querySelectorAll(".editf").forEach(x=>x.style.display="block");
    const btns = tr.querySelectorAll(".actions button");
    btns[0].style.display="none"; // تعديل
    btns[1].style.display="inline-block"; // حفظ
    btns[2].style.display="inline-block"; // إلغاء
  }

  function cancelEdit(id){
    loadOrders();
  }

  async function saveEdit(id){
    const tr = document.querySelector(`tr[data-id="${id}"]`);
    const inputs = tr.querySelectorAll(".editf");
    const payload = {};
    inputs.forEach(i=>{
      payload[i.getAttribute("data-k")] = i.value.trim();
    });

    setMsg("⏳ جاري حفظ التعديل...", "");
    try{
      await apiUpdate(id, payload);
      setMsg("✅ تم حفظ التعديل.", "ok");
      await loadOrders();
    }catch(err){
      setMsg("❌ فشل التعديل: " + err.message, "bad");
    }
  }

  async function del(id){
    if(!confirm("هل أنت متأكد من الحذف؟")) return;
    setMsg("⏳ جاري الحذف...", "");
    try{
      await apiDelete(id);
      setMsg("✅ تم الحذف.", "ok");
      await loadOrders();
    }catch(err){
      setMsg("❌ فشل الحذف: " + err.message, "bad");
    }
  }

  function exportCSV(){
    // Excel يفتح CSV عادي
    const rows = filtered.length ? filtered : orders;
    const head = ["id","name","phone","city","note","created_at"];
    const csv = [head.join(",")].concat(
      rows.map(o=>head.map(k=>{
        const v = String(o[k] ?? "");
        // Escape CSV
        if(v.includes('"') || v.includes(",") || v.includes("\n")) return `"${v.replaceAll('"','""')}"`;
        return v;
      }).join(","))
    ).join("\n");

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "orders.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // Auto open panel if logged
  if(localStorage.getItem("achir_admin_ok") === "1"){
    showPanel();
  }
</script>
</body>
  </html>
